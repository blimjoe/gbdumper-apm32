From 4b022355494dd2c00821487915cbaabeb6bf2dd4 Mon Sep 17 00:00:00 2001
From: Bo Dong <bdong@ucrobotics.com>
Date: Thu, 14 Mar 2024 17:36:30 +0800
Subject: [PATCH] LSE

---
 Application/Source/main.c             | 11 +++++
 Application/Source/system_apm32f10x.c | 58 +++++++++++++--------------
 2 files changed, 40 insertions(+), 29 deletions(-)

diff --git a/Application/Source/main.c b/Application/Source/main.c
index 8cb01f5..4ad1790 100644
--- a/Application/Source/main.c
+++ b/Application/Source/main.c
@@ -269,6 +269,17 @@ int main(void) {
 	GPIO_SetBit(GPIOB, GPIO_PIN_5);
 	// usb cdc
 	CDC_Init();
+	GPIO_Config_T  configStruct;
+	    RCM_EnableAPB2PeriphClock(RCM_APB2_PERIPH_GPIOC);
+		RCM_ConfigHSE(RCM_HSE_CLOSE);
+
+    /* Configure the GPIO_LED pin */
+    configStruct.pin = GPIO_PIN_13|GPIO_PIN_14|GPIO_PIN_15;
+    configStruct.mode = GPIO_MODE_OUT_PP;
+    configStruct.speed = GPIO_SPEED_2MHz;
+    GPIO_Config(GPIOC, &configStruct);
+	
+	GPIO_ResetBit(GPIOC, GPIO_PIN_14);
 	
 	//switchMode(0); // default GB/GBC mode
 	
diff --git a/Application/Source/system_apm32f10x.c b/Application/Source/system_apm32f10x.c
index 8c18692..d60fb19 100644
--- a/Application/Source/system_apm32f10x.c
+++ b/Application/Source/system_apm32f10x.c
@@ -3,7 +3,7 @@
  *
  * @brief       CMSIS Cortex-M3 Device Peripheral Access Layer System Source File
  *
- * @version     V1.0.4
+ * @version     V1.0.3
  *
  * @date        2022-12-01
  *
@@ -23,18 +23,18 @@
  *  and limitations under the License.
  */
 
-/* Includes */
+/*Includes*/
 #include "apm32f10x.h"
 
 /** @addtogroup Examples
   @{
-*/
+  */
 
-/** @addtogroup USB_CDC_VirtualCOMPort
+/** @addtogroup GPIO_Toggle
   @{
-*/
+  */
 
-/** @defgroup USB_CDC_VirtualCOMPort_System_Macros System_Macros
+/** @defgroup GPIO_Toggle_System_Macros System_Macros
   @{
 */
 
@@ -42,16 +42,16 @@
 //#define SYSTEM_CLOCK_24MHz  (24000000)
 //#define SYSTEM_CLOCK_36MHz  (36000000)
 //#define SYSTEM_CLOCK_48MHz  (48000000)
-//#define SYSTEM_CLOCK_56MHz  (56000000)
-#define SYSTEM_CLOCK_72MHz  (72000000)
+#define SYSTEM_CLOCK_56MHz  (56000000)
+//#define SYSTEM_CLOCK_72MHz  (72000000)
 //#define SYSTEM_CLOCK_96MHz  (96000000)
 
 /* #define VECT_TAB_SRAM */
 #define VECT_TAB_OFFSET     0x00
 
-/**@} end of group USB_CDC_VirtualCOMPort_System_Macros */
+/**@} end of group GPIO_Toggle_System_Macros*/
 
-/** @defgroup USB_CDC_VirtualCOMPort_System_Variables System_Variables
+/** @defgroup GPIO_Toggle_System_Variables System_Variables
   @{
 */
 
@@ -71,9 +71,9 @@
     uint32_t SystemCoreClock         = SYSTEM_CLOCK_96MHz;
 #endif
 
-/**@} end of group USB_CDC_VirtualCOMPort_System_Variables */
+/**@} end of group GPIO_Toggle_System_Variables*/
 
-/** @defgroup USB_CDC_VirtualCOMPort_System_Functions System_Functions
+/** @defgroup GPIO_Toggle_System_Functions System_Functions
   @{
 */
 
@@ -125,7 +125,7 @@ void SystemInit(void)
 #ifdef APM32F10X_CL
     /* Reset PLL2ON and PLL3ON bits */
     RCM->CTRL &= (uint32_t) 0xEBFFFFFF;
-    /* Disable all interrupts and clear pending bits */
+    /* Disable all interrupts and clear pending bits  */
     RCM->INT = 0x00FF0000;
     /* Reset CFG2 register */
     RCM->CFG2 = 0x00000000;
@@ -180,7 +180,7 @@ void SystemCoreClockUpdate(void)
 #ifdef APM32F10X_CL
             /* NOTE : PLL is the same as PLL1 */
             pllSource = RCM->CFG_B.PLL1SRCSEL;
-
+            
             /* PLL entry clock source is HSE */
             if (pllSource)
             {
@@ -192,7 +192,7 @@ void SystemCoreClockUpdate(void)
                 {
                     pll2Mull = (RCM->CFG2_B.PLL2MUL != 15) ? (RCM->CFG2_B.PLL2MUL + 2) : 20;
                     pllPsc2 = RCM->CFG2_B.PLLPSC2 + 1;
-
+                    
                     pllSource = ((HSE_VALUE / pllPsc2) * pll2Mull) / pllPsc1;
                 }
                 /* PLL entry clock source is HSE */
@@ -391,7 +391,7 @@ static void SystemClock24M(void)
         RCM->CFG_B.PLL1SRCSEL = 1;
         RCM->CFG_B.PLL1MULCFG = 4;
 #else
-        /* PLL configuration: PLLCLK = (HSE / 2) * 6 = 24 MHz */
+        /*  PLL configuration: PLLCLK = (HSE / 2) * 6 = 24 MHz */
         /* PLL: (HSE / 2) * 6 */
         RCM->CFG_B.PLL1SRCSEL = 1;
         RCM->CFG_B.PLLHSEPSC = 1;
@@ -467,7 +467,7 @@ static void SystemClock36M(void)
         RCM->CFG_B.PLL1SRCSEL = 1;
         RCM->CFG_B.PLL1MULCFG = 7;
 #else
-        /* PLL configuration: PLLCLK = (HSE / 2) * 9 = 36 MHz */
+        /*  PLL configuration: PLLCLK = (HSE / 2) * 9 = 36 MHz */
         /* PLL: (HSE / 2) * 9 */
         RCM->CFG_B.PLL1SRCSEL = 1;
         RCM->CFG_B.PLLHSEPSC = 1;
@@ -575,17 +575,17 @@ static void SystemClock56M(void)
 {
     __IO uint32_t i;
 
-    RCM->CTRL_B.HSEEN = BIT_SET;
+    RCM->CTRL_B.HSIEN = BIT_SET;
 
-    for (i = 0; i < HSE_STARTUP_TIMEOUT; i++)
-    {
-        if (RCM->CTRL_B.HSERDYFLG)
-        {
-            break;
-        }
-    }
+//    for (i = 0; i < HSE_STARTUP_TIMEOUT; i++)
+//    {
+//        if (RCM->CTRL_B.HSERDYFLG)
+//        {
+//            break;
+//        }
+//    }
 
-    if (RCM->CTRL_B.HSERDYFLG)
+    if (RCM->CTRL_B.HSIRDYFLG)
     {
         /* Enable Prefetch Buffer */
         FMC->CTRL1_B.PBEN = BIT_SET;
@@ -618,7 +618,7 @@ static void SystemClock56M(void)
         RCM->CFG_B.PLL1MULCFG = 5;
 #else
         /* PLL: HSE * 7 */
-        RCM->CFG_B.PLL1SRCSEL = 1;
+        RCM->CFG_B.PLL1SRCSEL = 0;
         RCM->CFG_B.PLL1MULCFG = 5;
 #endif
 
@@ -786,6 +786,6 @@ static void SystemClock96M(void)
 }
 #endif
 
-/**@} end of group USB_CDC_VirtualCOMPort_System_Functions */
-/**@} end of group USB_CDC_VirtualCOMPort */
+/**@} end of group GPIO_Toggle_System_Functions */
+/**@} end of group GPIO_Toggle */
 /**@} end of group Examples */
-- 
2.43.0.windows.1

